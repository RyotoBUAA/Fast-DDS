## DDS 协议模糊测试计划

### 1. 项目目标
对 DDS 协议进行模糊测试，检测协议实现中可能存在的安全漏洞和异常行为，最终在实际机器人（机器狗）上进行验证。

### 2. 测试架构

#### 2.1 节点设计（共4个节点）
- **1个异常节点（Fuzzer Node）**：作为攻击者，负责生成和发送畸形数据包
  - 配置模糊测试工具（AFL++/libFuzzer/自定义 fuzzer）
  - 拦截并修改正常的 DDS 消息
  - 注入各种异常数据包（畸形 RTPS 消息、越界数据、格式错误等）

- **3个正常节点（Monitor Nodes）**：作为受害者，接收数据并检测异常
  - Node 1: Publisher + Subscriber（启用 ASAN）
  - Node 2: Publisher + Subscriber（启用 UBSAN）
  - Node 3: Publisher + Subscriber（启用 ASAN + UBSAN）
  - 所有节点插入监控桩代码，记录异常行为

#### 2.2 消息类型
定义测试用的 DDS Topic 数据结构：
- 简单的测试消息（用于基础功能测试）
- 复杂的嵌套消息（用于深度测试）
- 包含各种数据类型的消息（测试序列化/反序列化）

### 3. 实施步骤

#### 阶段一：基础框架搭建 ✅
- [x] 创建 fuzzing_test 示例目录
- [x] 实现四个节点的基础通信框架
  - [x] FuzzerNode.cpp - 模糊测试节点
  - [x] MonitorNode.cpp - 监控节点（支持3个不同配置）
  - [x] Common.hpp/cpp - 公共功能模块
- [x] 定义测试消息的 IDL 文件
  - [x] SimpleTestMessage - 基础测试消息
  - [x] ComplexTestMessage - 复杂嵌套消息
  - [x] BoundaryTestMessage - 边界测试消息
- [x] 编写 CMakeLists.txt 支持 ASAN/UBSAN 编译选项
  - [x] 4个独立可执行文件配置
  - [x] 可选的 ASAN/UBSAN 编译标志
  - [x] 跨平台支持
- [x] 创建构建和运行脚本
  - [x] build_all.sh - 一键构建所有版本
  - [x] run_test.sh - 自动化测试脚本
  - [x] Makefile - 便捷命令接口
- [x] 编写文档
  - [x] README.md - 完整项目文档
  - [x] QUICKSTART.md - 快速入门指南
  - [x] PROJECT_STRUCTURE.md - 项目结构说明

#### 阶段二：模糊测试集成 🚧
- [x] 在异常节点集成模糊测试引擎
  - [x] 实现 FuzzEngine 类
  - [x] 实现字段篡改逻辑
  - [x] 支持多种变异策略（位翻转、边界值、随机数据等）
    - [x] 正常消息（基线）
    - [x] 位翻转
    - [x] 边界值测试
    - [x] 超大负载
    - [x] 随机数据
    - [x] 序列号混乱
    - [x] 特殊字符注入
    - [x] 空字符注入
    - [x] 溢出尝试
    - [x] 格式字符串测试
- [ ] 实现抓包和重放功能（pcap 库）（待开发）
- [ ] 添加 fuzzing corpus 管理（待开发）
- [ ] 集成 libFuzzer/AFL++（待开发）

#### 阶段三：监控与检测 ✅
- [x] 在正常节点添加监控桩代码
  - [x] 内存访问检测（AnomalyDetector::check_memory_corruption）
  - [x] 缓冲区溢出检测（ASAN/UBSAN 自动检测）
  - [x] 数据完整性检测（check_data_integrity）
  - [x] 序列号异常检测（check_sequence_anomaly）
  - [x] 字段值范围检测
  - [x] 异常崩溃捕获（SignalHandler）
- [x] 实现日志记录系统
  - [x] Logger 类（多级别日志）
  - [x] 文件和控制台双输出
  - [x] 异常检测专用日志
  - [x] 时间戳和格式化
- [x] 添加性能监控
  - [x] PerformanceMonitor 类
  - [x] 延迟测量
  - [x] 统计分析（均值、中位数、P95、P99）
  - [x] 吞吐量计算

#### 阶段四：POC 开发
- [ ] 分析发现的漏洞
- [ ] 编写可复现的 POC 代码
- [ ] 验证漏洞的触发条件
- [ ] 评估漏洞的影响范围和严重性

#### 阶段五：机器狗实战测试
- [ ] 将测试框架移植到机器狗平台
- [ ] 针对机器狗的 DDS 通信场景进行定制
- [ ] 实施实际攻击测试
- [ ] 验证异常检测和防护机制
- [ ] 生成测试报告

### 4. 技术要点

#### 4.1 模糊测试策略
- **协议层面**：篡改 RTPS 协议头、子消息类型、序列号等
- **数据层面**：修改 CDR 序列化数据、长度字段、类型信息
- **通信层面**：篡改传输层参数、QoS 设置、发现数据

#### 4.2 编译配置
```cmake
# ASAN 配置
-fsanitize=address -fno-omit-frame-pointer

# UBSAN 配置  
-fsanitize=undefined -fno-sanitize-recover=all

# 调试信息
-g -O1
```

#### 4.3 预期检测的问题类型
- 内存安全：缓冲区溢出、UAF、内存泄漏
- 类型安全：类型混淆、整数溢出、除零错误
- 逻辑错误：状态机错误、竞态条件
- 拒绝服务：资源耗尽、死锁

### 5. 输出物
- [ ] 完整的测试框架代码
- [ ] 发现的漏洞列表及 POC
- [ ] 测试报告（包括漏洞详情、复现步骤、影响分析）
- [ ] 机器狗实战测试视频和数据
- [ ] 安全加固建议

### 6. 时间规划
- 阶段一：1-2 周
- 阶段二：2-3 周  
- 阶段三：1-2 周
- 阶段四：1-2 周
- 阶段五：2-3 周

### 7. 当前状态

**已完成**：
- ✅ 阶段一：基础框架搭建（100%）
- 🚧 阶段二：模糊测试集成（60% - 基础模糊测试已实现，高级功能待开发）
- ✅ 阶段三：监控与检测（100%）

**进行中**：
- 阶段四：POC 开发（需要运行测试并分析结果）

**待开始**：
- 阶段五：机器狗实战测试

### 8. 已实现功能清单

#### 核心框架
- ✅ 4个独立节点（1个 Fuzzer + 3个 Monitor）
- ✅ DDS 通信基础设施（Publisher/Subscriber）
- ✅ 3种测试消息类型（Simple/Complex/Boundary）
- ✅ 完整的构建系统（CMake + 脚本）

#### 模糊测试能力
- ✅ 10种模糊测试策略
- ✅ 随机策略选择
- ✅ 可配置的发送速率和数量
- ✅ 性能监控

#### 异常检测
- ✅ ASAN 集成（内存错误检测）
- ✅ UBSAN 集成（未定义行为检测）
- ✅ 自定义异常检测器
- ✅ 实时日志和告警

#### 自动化工具
- ✅ 一键构建脚本（build_all.sh）
- ✅ 自动化测试脚本（run_test.sh）
- ✅ Makefile 便捷命令
- ✅ 完整文档（README + QUICKSTART + 项目结构）

### 9. 下一步行动

1. **运行初步测试**
   ```bash
   cd examples/cpp/fuzzing_test
   make build
   make test
   make check-anomalies
   ```

2. **分析测试结果**
   - 查看日志中的异常检测
   - 检查 Sanitizer 输出
   - 评估当前的测试覆盖率

3. **迭代优化**
   - 根据结果调整模糊测试策略
   - 添加更多检测规则
   - 优化性能

4. **开发高级功能**
   - 集成 libFuzzer/AFL++
   - 实现抓包和重放
   - 协议层面的 RTPS 消息篡改

5. **准备机器狗测试**
   - 评估机器狗平台的 DDS 配置
   - 针对性调整测试策略
   - 制定实战测试计划